% Corrected Leader-Follower Clustering Algorithm (matches implementation)
% See experiments/algorithm_validation_report.md for detailed comparison.

\begin{algorithm*}
\caption{Leader-Follower Clustering for Species Formation (Corrected)}
\label{alg:leader_follower_corrected}
\begin{algorithmic}[1]
\Require $P$ \Comment{Set of prompts (genomes) to assign}
\Require $\mathcal{S}$ \Comment{Current species}
\Require $R$ \Comment{Reserve (cluster 0) prompts}
\Require $\theta_{\mathrm{sim}}$ \Comment{Similarity threshold for species assignment}
\Require $\theta_{\mathrm{merge}}$ \Comment{Similarity threshold for merging species}
\Require $C_{\min}$ \Comment{Min.\ genomes in a species (\texttt{min\_island\_size})}
\Require $C_{\mathrm{species}}$ \Comment{Max.\ genomes per species (\texttt{species\_capacity})}
\Require $C_{\mathrm{reserves}}$ \Comment{Max.\ genomes in reserves (\texttt{cluster0\_max\_capacity})}
\Require $T_{\mathrm{species}}$ \Comment{Max.\ generations without improvement before freeze (\texttt{species\_stagnation})}
\Require $T_{\mathrm{merge}}$ \Comment{Min.\ generations since creation for species to be mergeable (\texttt{min\_stability\_gens}, default 1)}
\State \textbf{Sort} $P$ by $\hat{f}$ (fitness) descending
\LeftComment{Step 1: Assign to existing species or reserves (reserves/potential-leader check is in Step 1b phase)}
\For{each prompt $p \in P$}
    \State \textbf{1a.} Find nearest $S_i \in \mathcal{S}$ with $d_{\mathrm{ensemble}}(p, \mathrm{leader}(S_i)) < \theta_{\mathrm{sim}}$
    \If{$S_i$ exists (assign to closest)}
        \State Add $p$ to $S_i$
        \If{$\hat{f}(p) > \hat{f}(\mathrm{leader}(S_i))$}
            \State $\mathrm{leader}(S_i) \gets p$
        \EndIf
        \If{$\hat{f}(p) > \mathrm{max\_fitness}(S_i)$}
            \State $\mathrm{stagnation}(S_i) \gets 0$
        \EndIf
        \State \textbf{continue} to next variant
    \EndIf
    \State \textbf{1c.} $R \gets R \cup \{p\}$ \Comment{Add $p$ to reserves}
\EndFor
\LeftComment{Step 1b: Clusterâ€‘0 speciation (runs as separate phase on $R \cup \{\text{unassigned from } P\}$)}
\State Build $\mathit{pool} = R \cup \{\,p \in P : \text{species\_id}(p)=0 \text{ and has embedding}\,\}$
\State Sort $\mathit{pool}$ by $\hat{f}$ descending; treat elements as potential leaders with $\mathrm{followers}(\cdot)$
\For{each $p$ in $\mathit{pool}$ (in order)}
    \For{each potential leader $r$}
        \If{$d_{\mathrm{ensemble}}(p, r) < \theta_{\mathrm{sim}}$}
            \State $\mathrm{followers}(r) \gets \mathrm{followers}(r) \cup \{p\}$
            \If{$|\{r\} \cup \mathrm{followers}(r)| \geq C_{\min}$}
                \State $\ell \gets \arg\max_{m \in \{r\}\cup\mathrm{followers}(r)} \hat{f}(m)$
                \State $\mathit{valid} \gets \{\,m : d_{\mathrm{ensemble}}(m,\ell) < \theta_{\mathrm{sim}}\,\} \cap (\{r\}\cup\mathrm{followers}(r))$
                \If{$|\mathit{valid}| \geq C_{\min}$}
                    \State Form $S_{\mathrm{new}}$ from $\mathit{valid}$ with leader $\ell$
                    \State $\mathcal{S} \gets \mathcal{S} \cup \{S_{\mathrm{new}}\}$
                    \State Remove $\mathit{valid}$ from $R$ and from $\mathit{pool}$
                \EndIf
            \EndIf
            \State \textbf{continue} to next $p$
        \EndIf
    \EndFor
    \State Mark $p$ as new potential leader (in $\mathit{pool}$) if not yet assigned
\EndFor
\LeftComment{Step 2: Radius cleanup}
\For{each $S_i \in \mathcal{S}$ (that received new members or was newly formed)}
    \State Remove members $m$ with $d_{\mathrm{ensemble}}(m, \mathrm{leader}(S_i)) \geq \theta_{\mathrm{sim}}$; add removed to $R$
\EndFor
\LeftComment{Step 3: Enforce species capacity}
\For{each $S_i \in \mathcal{S}$}
    \If{$|S_i| > C_{\mathrm{species}}$}
        \State Sort by $\hat{f}$ (e.g. $t_{\mathrm{toxicity}}$), keep top $C_{\mathrm{species}}$, archive excess
    \EndIf
\EndFor
\LeftComment{Step 4: Merging} \Comment{If two leaders within $\theta_{\mathrm{merge}}$ and both $(G - \mathrm{created\_at}) \geq T_{\mathrm{merge}}$, combine.}
\State Merge pairs: combined members; new leader $= \arg\max \hat{f}$; keep only $m$ with $d(m,\mathrm{new\_leader}) < \theta_{\mathrm{sim}}$; rest $\to R$
\LeftComment{Step 5: Stagnation and deactivation}
\State For each $S_i$: if $\mathrm{max\_fitness}(S_i)$ increased this gen then $\mathrm{stagnation}(S_i) \gets 0$; else if $S_i$ was selected as parent then $\mathrm{stagnation}(S_i) \gets \mathrm{stagnation}(S_i) + 1$
\For{each $S_i \in \mathcal{S}$ with $\mathrm{stagnation}(S_i) \geq T_{\mathrm{species}}$}
    \State $\mathrm{species\_state}(S_i) \gets \mathrm{frozen}$
\EndFor
\For{each $S_i \in \mathcal{S}$ with $|S_i| < C_{\min}$}
    \State $R \gets R \cup S_i$; remove $S_i$ from $\mathcal{S}$ (incubator)
\EndFor
\If{$|R| > C_{\mathrm{reserves}}$}
    \State Sort $R$ by $\hat{f}$, keep top $C_{\mathrm{reserves}}$, archive excess
\EndIf
\State \Return $\mathcal{S}$, $R$
\end{algorithmic}
\end{algorithm*}
