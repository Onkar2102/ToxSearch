# Communication and Data Flow: RunEvolution.py, EvolutionEngine.py, Selection, Mutation, and Crossover Operators

## Overview
This document explains how the main evolutionary pipeline components in the `src/ea/` package interact, what data is shared between them, and the purpose of their key methods.

---

## 1. High-Level Pipeline

- **RunEvolution.py**: Orchestrates the overall evolutionary process (main loop, logging, threshold checks, etc.).
- **EvolutionEngine.py**: Implements the core logic for each evolution cycle (parent selection, operator application, population updates).
- **ParentSelector (Selection)**: Selects parent genomes for mutation/crossover, saves them to `parents.json`.
- **Mutation/Crossover Operators**: Read parents from `parents.json`, generate variants, and save results to `temp.json`.

---

## 2. Data Files Shared

- **parents.json**: Contains selected parent genomes (mutation parent and crossover parents) for the current cycle.
- **temp.json**: Contains all variants generated by mutation/crossover operators for the current cycle.
- **elites.json**: Stores the elite genomes (top performers) for steady-state evolution.
- **Population files**: Store the full population and its metadata.

---

## 3. Component Communication

### A. RunEvolution.py
- Calls `EvolutionEngine` to run a full evolution cycle.
- Handles logging, threshold checks, and may update trackers.
- Does **not** directly call selection or operators.

### B. EvolutionEngine.py
- Instantiated with all key parameters (e.g., `north_star_metric`, `max_variants`, `adaptive_selection_after`).
- Calls `ParentSelector` to select parents and save them to `parents.json`.
- Triggers mutation/crossover operators (usually via a loop or dispatcher) to generate variants.
- Reads variants from `temp.json` after operators finish.
- Updates population and elites based on new variants.

### C. ParentSelector (Selection)
- Method: `adaptive_tournament_selection(x, y)`
    - Selects mutation and crossover parents from elites and population.
    - Saves selected parents to `outputs/parents.json`.
- Method: `save_top_10_by_toxicity()`
    - Saves top 10 genomes by toxicity to `outputs/top_10.json` (for analysis).


### D. Mutation/Crossover Operators
- Each operator reads only `parents.json` (and optionally `top_10.json` for special logic) to get the required parent genome(s).
- Operators do **not** read or write to `elites.json` or `population.json`.
- Each operator's `apply()` method generates variants from the parent(s).
- All generated variants are saved to `outputs/temp.json` (using a utility function).
- Operators do **not** update the population directly.

---

## 4. Method Purposes

- **RunEvolution.py**
    - `run_evolution(...)`: Main entry point for running a full evolution cycle.

- **EvolutionEngine.py**
    - `generate_variants_global(x, y)`: Runs parent selection, triggers operators, collects variants, updates population.
    - `update_next_id()`: Ensures unique genome IDs.
    - `_extract_north_star_score(genome)`: Utility for fitness evaluation.

- **ParentSelector**
    - `adaptive_tournament_selection(x, y)`: Selects and saves parents for the current cycle.
    - `determine_parent_counts(evolution_tracker)`: Decides how many parents to select from elites/population.
    - `save_top_10_by_toxicity()`: For analysis, not used in main loop.
    - `clean_parents_file()`: Cleans up `parents.json` and `top_10.json` after use.

- **Operators**
    - `apply(operator_input)`: Main method to generate variants from parent(s). Reads from `parents.json`, writes to `temp.json`.

---

## 5. Data Flow Example (One Evolution Cycle)

1. **Parent Selection**
    - `EvolutionEngine` calls `ParentSelector.adaptive_tournament_selection(x, y)`
    - Parents are saved to `outputs/parents.json`
2. **Operator Application**
    - Operators read `parents.json`, generate variants, and save to `outputs/temp.json`
3. **Population Update**
    - `EvolutionEngine` reads `temp.json`, integrates new variants into the population, updates `elites.json` and trackers
4. **Cleanup**
    - `ParentSelector.clean_parents_file()` removes `parents.json` and `top_10.json`

---

## 6. Key Points
- All data exchange between selection, mutation, and crossover is via JSON files (`parents.json`, `temp.json`).
- `RunEvolution.py` is the orchestrator, but all direct data flow is handled by `EvolutionEngine` and the operators.
- Operators are stateless: they only read parents and write variants for each cycle.
- The design supports modularity and easy debugging by inspecting the JSON files at each stage.
