================================================================================
FIELD DEFINITIONS: JSON AND CSV FILES
ToxSearch with Speciation — validated against code implementation
================================================================================

This document defines every field and subfield in the JSON and CSV files produced
or consumed by the project. Definitions are derived from: population_io.py,
run_speciation.py, species.py, reserves.py, config.py, metrics.py, operator_
effectiveness.py, cluster_quality.py, parent_selector.py, evolution_engine.py,
evaluator.py, response_generator.py, genome_tracker.py, and main.py.

--------------------------------------------------------------------------------
1. GENOME OBJECT (shared structure)
--------------------------------------------------------------------------------
Used in: elites.json, reserves.json, archive.json, temp.json; and when
referencing genomes in parents.json, top_10.json, speciation_state (member_ids
point to genome "id" in elites).

  id                      int. Globally unique genome ID. Assigned via
                          evolution_engine.next_id (max over elites, reserves,
                          archive + 1). Never reused.

  prompt                  str. The textual prompt (question) for the genome.

  generation              int. Generation in which this genome was created.
                          Gen 0 = initial population; N = from operators in gen N.

  species_id              int. 0 = reserves (cluster 0); 1+ = species ID.
                          Set by leader-follower clustering and distribution.
                          Must be 0 in reserves.json; must be >0 in elites.json.

  fitness                 float. North-star score (toxicity) used for speciation.
                          Synced from moderation_result / toxicity / north_star_score
                          via _extract_north_star_score. Stored when converting
                          Individual to genome dict.

  initial_state           str. "elite" or "non-elite". Set at distribution:
                          "elite" for genomes in elites or reserves; "non-elite"
                          for archived (e.g. capacity, rejection).

  prompt_embedding        list[float]. Vector from sentence-transformers (e.g.
                          all-MiniLM-L6-v2). Stored in elites.json and reserves.json
                          for clustering; removed before archiving.

  moderation_result       object. From evaluator (Google Perspective API or hybrid).
                          Standard: { "google": { "scores": { "toxicity": float } } };
                          legacy: { "scores": { "toxicity": float } }.
                          _extract_north_star_score reads toxicity from here.

  toxicity                float. Direct toxicity score (slimmed formats, e.g.
                          parents.json, top_10.json). Alternative to
                          moderation_result for _extract_north_star_score.

  north_star_score        float. Optional precomputed north-star metric.

  generated_output        str. Model response text. Set by response_generator;
                          used by evaluator.

  model_name              str. Response generator model name. Set by
                          response_generator.

  response_duration       float. Seconds for response generation. Used in
                          budget llm_calls / total_response_time.

  evaluation_duration     float. Seconds for moderation. Used in budget
                          api_calls / total_evaluation_time.

  status                  str. "pending_generation" | "pending_evaluation" |
                          "complete" | "error". Set by response_generator and
                          evaluator.

  error                   str. Set when status="error".

  operator                str. Name of variation operator that created this
                          genome (e.g. "LLMBasedParaphrasing").

  variant_type            str. "mutation" or "crossover".

  parents                 list. From evolution_engine create_child: [{"id", "score"}]
                          for each parent.

  parent_score            float. Score used for variant creation.

  creation_info           object. { "type", "operator", "parent_score" }.
                          Optional variant_creation_duration.

  genome_data             (in-memory only) Full genome dict on Individual;
                          not serialized to JSON.

--------------------------------------------------------------------------------
2. elites.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/elites.json  
Format: JSON array of genome objects.

  Contains: genome objects with species_id > 0.
  - All fields from §1 as applicable.
  - prompt_embedding: kept for speciation and cluster quality.
  - initial_state: "elite".
  - species_id: must be > 0 (species 0 is reserves).

  Cumulative: all elites from all generations up to current. Filter by
  generation when computing per-generation stats.

--------------------------------------------------------------------------------
3. reserves.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/reserves.json  
Format: JSON array of genome objects.

  Contains: genome objects with species_id = 0 (cluster 0 / reserves).
  - initial_state: "elite".
  - species_id: 0.
  - Sorted by toxicity (desc). Capacity-limited to cluster0_max_capacity;
    excess archived.

  Cumulative: all reserves up to current generation.

--------------------------------------------------------------------------------
4. archive.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/archive.json  
Format: JSON array of genome objects.

  Contains: archived genomes (capacity overflow, non-elite, etc.).
  - initial_state: "non-elite".
  - prompt_embedding: removed before archiving to save space.

  Cumulative: all archived genomes. Not part of the active population.

--------------------------------------------------------------------------------
5. temp.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/temp.json  
Format: JSON array of genome objects.

  Transient: new variants for the current generation, before speciation and
  distribution. After distribution, typically cleared or holds leftovers.
  - Same genome fields as §1. species_id set by leader-follower then
    distribution; prompts without embeddings may stay in temp until
    compute_and_save_embeddings.

--------------------------------------------------------------------------------
6. EvolutionTracker.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/EvolutionTracker.json  
Format: JSON object.

---- 6.1 Top-level ----

  status                  str. "not_complete" | "complete" (or similar).
                          Indicates run completion.

  total_generations       int. Updated by update_population_index_single_file
                          from get_population_files_info (max generation in
                          tracker + 1 or derived from files).

  generations_since_improvement  int. Generations without population_max_toxicity
                          increase. For adaptive selection.

  avg_fitness_history     list[float]. Sliding window of recent generations'
                          avg_fitness. Used for slope_of_avg_fitness.

  slope_of_avg_fitness    float. From avg_fitness_history. Drives selection
                          mode (exploit when slope <= 0).

  selection_mode          str. "default" | "exploit" | "explore". Adaptive
                          parent selection mode.

  population_max_toxicity float. Cumulative max of best_fitness across all
                          generations.

  speciation_summary      object. Latest summary:
    current_species_count     int.
    current_reserves_size     int.
    total_speciation_events   int.
    total_merge_events        int.
    total_extinction_events   int.

  cumulative_budget       object. Running totals:
    total_llm_calls           int.
    total_api_calls           int.
    total_response_time       float.
    total_evaluation_time     float.

  cluster_quality         object. From cluster_quality.calculate_cluster_quality_
                          metrics when saved via save_cluster_quality_to_tracker.
    silhouette_score          float. [-1,1]; higher = better separation.
    davies_bouldin_index      float. >=0; lower = better.
    calinski_harabasz_index   float. Higher = better.
    qd_score                  float. Quality × inter_species_diversity.
    num_samples               int. Genomes with embedding and species_id>0.
    num_clusters              int. Distinct species in that set.
    num_species_total         int. (optional) Active+frozen species count.

---- 6.2 generations[] (per-generation entry) ----

  generation_number       int. 0-based generation index.

  genome_id               str|int. Best genome ID for this generation (e.g.
                          highest toxicity in population for this gen). Can be
                          None.

  max_score_variants      float. Max toxicity among variants created this gen
                          (from temp before speciation). Fallback 0.0001.

  min_score_variants      float. Min toxicity among those variants.

  avg_fitness             float. Mean over elites + reserves + temp before
                          speciation, after evaluation (and refusal penalty).
                          From calculate_average_fitness(include_temp=True) in
                          main; computed after evaluation and before
                          run_speciation.

  avg_fitness_generation  float. Mean over elites + reserves only (living
                          population) after distribution.

  avg_fitness_variants    float. Mean over this gen's variants in temp (before
                          speciation).

  avg_fitness_elites      float. Mean over elites (up to current gen).

  avg_fitness_reserves     float. Mean over reserves (up to current gen).

  parents                 list. Parent genomes or slimmed entries; can be [].

  top_10                  list. Top 10 genomes by fitness; can be [].

  variants_created        int. Total variants generated this gen before
                          dedup/rejection (remaining + duplicates + rejections).

  mutation_variants       int. Variants in temp with variant_type=="mutation".

  crossover_variants      int. Variants in temp with variant_type=="crossover".

  elites_count            int. Count in elites with generation <= current.
                          From calculate_generation_statistics.

  reserves_count          int. Count in reserves with generation <= current.

  archived_count          int. Count in archive with generation <= current.

  total_population        int. elites_count + reserves_count.

  selection_mode          str. Mode for this generation.

  operator_statistics     object. Per-operator: rejections, duplicates, etc.
    <operator_name>:
      rejections_removed       int.
      duplicates_removed       int.
      (or rejections, duplicates)

  speciation              object. See §6.3.

  budget                  object | null. This generation:
    llm_calls                 int.
    api_calls                 int.
    total_response_time       float.
    total_evaluation_time     float.

---- 6.3 generations[].speciation ----

  species_count           int. Active + frozen species.

  active_species_count    int. species_state=="active" only.

  frozen_species_count    int. species_state=="frozen" only.

  reserves_size           int. Size of reserves (cluster 0).

  speciation_events       int. New species formed this gen.

  merge_events            int. Species merged this gen.

  extinction_events       int. Species extinct (frozen/incubator) this gen.

  archived_count          int. Genomes archived this gen (e.g. capacity).

  elites_moved            int. Genomes moved to elites this gen (from
                          distribute_genomes).

  reserves_moved          int. Genomes moved to reserves this gen.

  genomes_updated         int. Genomes with species_id updated.

  inter_species_diversity float. From record_generation / metrics.

  intra_species_diversity float.

  total_population        int. elites + reserves at record time.

  cluster_quality         object | null. Same shape as §6.1 cluster_quality.

  (best_fitness and avg_fitness are not in speciation; they are at gen level
   only: population_max_toxicity, max_score_variants, avg_fitness.)

--------------------------------------------------------------------------------
7. speciation_state.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/speciation_state.json  
Format: JSON object. Written by save_state in run_speciation.

---- 7.1 species{} (key = species id string) ----

  id                      int. Species ID (1+).

  leader_id               int. Genome ID of the leader (highest fitness).

  leader_prompt           str.

  leader_embedding        list[float] | null. For state restore.

  leader_fitness          float.

  leader_distance         float. Ensemble distance (0–1) for leader.

  member_ids              list[int]. Genome IDs in this species. Source of
                          truth aligned with elites.json for that species_id.

  size                    int. len(member_ids).

  radius                  float. Theta_sim (distance threshold).

  stagnation              int. Incremented when selected as parent and
                          max_fitness did not increase; 0 when max_fitness
                          increased.

  max_fitness             float. Max over current members only.

  min_fitness             float. Min over current members.

  species_state           str. "active" | "frozen" | "incubator" | "extinct".

  created_at              int. Generation when species was created.

  last_improvement        int. Generation when max_fitness last increased.

  fitness_history         list[float]. Last 20 best-fitness values.

  labels                  list[str]. Current c-TF-IDF labels (e.g. top 10).

  label_history           list. Last 20 label entries.

  cluster_origin          str. "natural" | "merge" | "split".

  parent_ids              list[int] | null. For merge: [id1, id2]; for split:
                          [id1]; natural: null or [].

---- 7.2 incubators ----

  incubators              list[int]. Species IDs in "incubator" state (stored
                          by ID only; members in reserves or cleared).

---- 7.3 cluster0 ----

  cluster_id              int. 0.

  size                    int. Overwritten at save from reserves.json length
                          (actual file count).

  max_capacity             int. cluster0_max_capacity.

  speciation_events       list. Last 10 speciation-from-cluster0 events. Each:
                          { "leader_id", "leader_fitness", ... }.

  max_fitness             float. Max over reserves (including 0). Set at
                          save_state from reserves.json.

  min_fitness             float. Min over reserves.

---- 7.4 cluster0_size_from_reserves ----

  cluster0_size_from_reserves  int. len(reserves.json) at save (duplicate of
                          cluster0.size for validation).

---- 7.5 global_best_id ----

  global_best_id          int | null. Genome ID of global best.

---- 7.6 metrics ----

  metrics                 object. From metrics_tracker.to_dict():
    history                list. Per-generation:
      generation, species_count, total_population, reserves_size,
      best_fitness, avg_fitness, fitness_std,
      speciation_events, merge_events, extinction_events,
      inter_species_diversity, intra_species_diversity,
      cluster_quality (optional).
    summary                object. Aggregates (total_speciation, etc.).

---- 7.7 config ----

  config                  object. SpeciationConfig.to_dict():
    theta_sim, theta_merge, cluster0_min_cluster_size, cluster0_max_capacity,
    species_capacity, min_island_size, species_stagnation,
    embedding_model, embedding_dim, embedding_batch_size,
    w_genotype, w_phenotype.

---- 7.8 _archived_genomes ----

  _archived_genomes       list. In-memory list of archived genome dicts for
                          this run; appended when capacity forces archive.
                          Used to update archive.json.

--------------------------------------------------------------------------------
8. genome_tracker.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/genome_tracker.json  
Format: JSON object. Consolidated across generations.

  generations             list. Per gen:
    generation             int.
    total_events           int.
    events                 list. Each:
      genome_id            str|int.
      event                str. e.g. "clustering_assigned", "capacity_archived",
                          "species_merged".
      generation           int.
      timestamp            str. ISO.
      details              object. e.g. { "species_id", "reason" }.

  summary                 object:
    total_generations      int.
    total_events           int.
    last_updated           str. ISO.

--------------------------------------------------------------------------------
9. parents.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/parents.json  
Format: JSON array of slimmed parent objects. Written by parent_selector.

  [].id                   int. Genome ID.
  [].prompt               str.
  [].toxicity             float. North-star score.
  [].species_id           int.

--------------------------------------------------------------------------------
10. top_10.json
--------------------------------------------------------------------------------
Location: data/outputs/<run>/top_10.json  
Format: JSON array of slimmed genome objects. Top 10 by toxicity from
elites + reserves. Written by parent_selector._save_top_10_by_toxicity.

  [].id                   int.
  [].prompt               str.
  [].toxicity             float.

--------------------------------------------------------------------------------
11. operator_effectiveness_cumulative.csv
--------------------------------------------------------------------------------
Location: data/outputs/<run>/operator_effectiveness_cumulative.csv  
Format: CSV. One row per (generation, operator). Columns (order as in code):

  generation              int. Generation number.

  operator                str. Operator name.

  NE                      float. Non-Elite % = non_elite_count / calculated_total
                          × 100. (Variants that ended in archive.)

  EHR                     float. Elite Hit Rate = elite_count / calculated_total
                          × 100. (Variants that became elite or reserve.)

  IR                      float. Rejection % = rejections / calculated_total × 100.

  cEHR                    float. Conditional EHR = elite_count / total_variants
                          × 100. (Of valid variants, % that became elite; excludes
                          rejections and duplicates.)

  Δμ                      float. Mean(current_toxicity - parent_score) over
                          this gen's variants for this operator. NaN if none.

  Δσ                      float. Std(current_toxicity - parent_score). NaN if
                          none or single.

  total_variants          int. elite_count + non_elite_count (successful variants
                          for this operator this gen).

  elite_count             int. Variants in elites or reserves with
                          initial_state="elite" and generation==current and
                          operator matches.

  non_elite_count         int. Variants in archive with generation==current and
                          operator matches.

  rejections              int. From operator_statistics for this operator.

  duplicates              int. From operator_statistics.

  (calculated_total is not a CSV column; it is total_variants + rejections +
   duplicates, used in NE, EHR, IR, cEHR formulas.)

--------------------------------------------------------------------------------
12. data/prompt.csv (input)
--------------------------------------------------------------------------------
Seed prompts for generation 0. Must have:

  questions               str. Column used for initial prompts. (Also
                          "prompt" in some loaders; see data_loader.)

--------------------------------------------------------------------------------
13. validation_report.json (output of comprehensive_validation)
--------------------------------------------------------------------------------
Location: data/outputs/<run>/validation_report.json  
Produced by experiments/comprehensive_validation.py. Structure is that
script’s return; typically includes execution_dir, validations_passed,
validations_failed, issues, warnings, total_issues, total_warnings.

--------------------------------------------------------------------------------
EXTRACTION OF NORTH-STAR SCORE (_extract_north_star_score)
--------------------------------------------------------------------------------
Used for toxicity (or other north_star_metric) from genomes. Priority:

  1. moderation_result["google"]["scores"][metric]
  2. moderation_result["scores"][metric]
  3. genome[metric] (e.g. "toxicity")
  4. genome["scores"][metric]

Returns at least 0.0001 if absent or zero.

--------------------------------------------------------------------------------
END OF FIELD DEFINITIONS
--------------------------------------------------------------------------------
